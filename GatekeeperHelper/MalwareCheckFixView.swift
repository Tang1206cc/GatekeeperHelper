//
//  MalwareCheckFixView.swift
//  GatekeeperHelper
//
//  Created by 唐梓耀 on 2025/8/1.
//

import Foundation
import SwiftUI
import AppKit

struct MalwareCheckFixView: View {
    var dismiss: () -> Void

    var body: some View {
        VStack(alignment: .leading, spacing: 16) {
            // 标题栏 + 关闭按钮
            HStack {
                Text("解决方案：无法打开 App，因为 Apple 无法检查其是否包含恶意软件")
                    .font(.title2)
                    .bold()
                    .lineLimit(2)
                    .fixedSize(horizontal: false, vertical: true)

                Spacer()

                Button(action: dismiss) {
                    Image(systemName: "xmark.circle.fill")
                        .foregroundColor(.gray)
                        .imageScale(.large)
                }
                .buttonStyle(.plain)
            }

            Divider()

            ScrollView {
                VStack(alignment: .leading, spacing: 14) {
                    Text("这是由于 macOS Catalina 及更高版本要求 App 必须通过 Apple 的公证（Notarization）验证。若 App 未通过验证，将提示“无法检查是否包含恶意软件”。")

                    Text("解决方式如下：")

                    Text("1. 打开该 App，会看到系统提示框。\n2. 点击“好”关闭提示。\n3. 打开『系统设置』→『隐私与安全性』。\n4. 滚动到底部，在“仍要打开”处点击“允许”。\n5. 输入密码后即可运行该 App。")

                    Rectangle()
                        .fill(Color.gray.opacity(0.1))
                        .frame(height: 180)
                        .overlay(
                            Text("【图片占位】展示系统设置中“仍要打开”按钮位置")
                                .foregroundColor(.gray)
                        )
                }
                .font(.body)
            }

            Spacer()

            HStack {
                Spacer()

                Button("跳转至设置界面") {
                    if let url = URL(string: "x-apple.systempreferences:com.apple.preference.security?General") {
                        NSWorkspace.shared.open(url)
                    }
                }
                .keyboardShortcut(.defaultAction)
            }
        }
        .padding(20)
        .frame(minWidth: 620, minHeight: 460)
    }
}
